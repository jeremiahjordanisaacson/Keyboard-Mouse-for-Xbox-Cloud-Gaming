name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag or input
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Update manifest versions
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          jq --arg v "$VERSION" '.version = $v' manifest.json > tmp.json && mv tmp.json manifest.json
          jq --arg v "$VERSION" '.version = $v' firefox/manifest.json > tmp.json && mv tmp.json firefox/manifest.json

      - name: Package browser extensions
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          mkdir -p dist

          # Files to include in Chromium-based builds
          CHROMIUM_FILES="manifest.json content.js injected.js popup.html popup.js icons/"

          # Chromium-based browsers (all use the same extension format)
          CHROMIUM_BROWSERS="Chrome Edge Brave Opera Vivaldi Yandex Whale CocCoc 360Browser QQBrowser SogouExplorer Ecosia"

          for BROWSER in $CHROMIUM_BROWSERS; do
            zip -r "dist/Xbox-Cloud-Gaming-KBM-${BROWSER}-v${VERSION}.zip" $CHROMIUM_FILES -x "*.git*"
          done

          # Firefox-based browsers
          mkdir -p firefox-build
          cp content.js injected.js popup.html popup.js firefox-build/
          cp -r icons firefox-build/
          cp firefox/manifest.json firefox-build/manifest.json
          cd firefox-build

          FIREFOX_BROWSERS="Firefox PaleMoon"
          for BROWSER in $FIREFOX_BROWSERS; do
            zip -r "../dist/Xbox-Cloud-Gaming-KBM-${BROWSER}-v${VERSION}.zip" .
          done

      - name: Generate SHA256 checksums
        run: |
          cd dist
          for file in *.zip; do
            sha256sum "$file" > "${file}.sha256"
          done
          sha256sum *.zip > SHA256SUMS.txt
          echo "=== All Checksums ==="
          cat SHA256SUMS.txt

      - name: Generate release notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cat > release_notes.md << 'NOTES'
          ## Keyboard & Mouse for Xbox Cloud Gaming

          Play Xbox Cloud Gaming with full keyboard and mouse support.

          ---

          ### Download for Your Browser

          #### Chromium-Based Browsers
          | Browser | Download | Checksum |
          |---------|----------|----------|
          NOTES

          # Chromium browsers
          for BROWSER in Chrome Edge Brave Opera Vivaldi Yandex Whale CocCoc 360Browser QQBrowser SogouExplorer Ecosia; do
            ZIP="Xbox-Cloud-Gaming-KBM-${BROWSER}-v${VERSION}.zip"
            # Display names
            case $BROWSER in
              CocCoc) DISPLAY="Cốc Cốc" ;;
              360Browser) DISPLAY="360 Safe Browser" ;;
              QQBrowser) DISPLAY="QQ Browser" ;;
              SogouExplorer) DISPLAY="Sogou Explorer" ;;
              Yandex) DISPLAY="Yandex Browser" ;;
              Whale) DISPLAY="Naver Whale" ;;
              *) DISPLAY="$BROWSER" ;;
            esac
            echo "| **${DISPLAY}** | [Download](https://github.com/${{ github.repository }}/releases/download/v${VERSION}/${ZIP}) | [SHA256](https://github.com/${{ github.repository }}/releases/download/v${VERSION}/${ZIP}.sha256) |" >> release_notes.md
          done

          cat >> release_notes.md << 'NOTES'

          #### Firefox-Based Browsers
          | Browser | Download | Checksum |
          |---------|----------|----------|
          NOTES

          # Firefox browsers
          for BROWSER in Firefox PaleMoon; do
            ZIP="Xbox-Cloud-Gaming-KBM-${BROWSER}-v${VERSION}.zip"
            case $BROWSER in
              PaleMoon) DISPLAY="Pale Moon" ;;
              *) DISPLAY="$BROWSER" ;;
            esac
            echo "| **${DISPLAY}** | [Download](https://github.com/${{ github.repository }}/releases/download/v${VERSION}/${ZIP}) | [SHA256](https://github.com/${{ github.repository }}/releases/download/v${VERSION}/${ZIP}.sha256) |" >> release_notes.md
          done

          cat >> release_notes.md << 'NOTES'

          ---

          ### Installation Instructions

          #### Chromium-Based Browsers (Chrome, Edge, Brave, Opera, Vivaldi, Yandex, Whale, Cốc Cốc, 360, QQ, Sogou, Ecosia)

          1. Download the zip file for your browser from the table above
          2. Extract the zip file to a folder on your computer
          3. Open your browser's extension page:
             - **Chrome**: `chrome://extensions`
             - **Edge**: `edge://extensions`
             - **Brave**: `brave://extensions`
             - **Opera**: `opera://extensions`
             - **Vivaldi**: `vivaldi://extensions`
             - **Yandex**: `browser://extensions`
             - **Whale**: `whale://extensions`
             - **Cốc Cốc**: `coccoc://extensions`
             - **360 Safe Browser**: Settings → Extensions
             - **QQ Browser**: Settings → Extensions
             - **Sogou Explorer**: Settings → Extensions
             - **Ecosia**: `chrome://extensions`
          4. Enable **Developer mode** (usually a toggle in the top-right or sidebar)
          5. Click **Load unpacked**
          6. Select the extracted folder

          #### Firefox-Based Browsers (Firefox, Pale Moon)

          1. Download the Firefox or Pale Moon zip from the table above
          2. Open the debugging page:
             - **Firefox**: `about:debugging#/runtime/this-firefox`
             - **Pale Moon**: `about:debugging`
          3. Click **Load Temporary Add-on**
          4. Select the downloaded zip file (no need to extract)

          ---

          ### Browser Compatibility Notes

          | Status | Browsers |
          |--------|----------|
          | ✅ **Fully Supported** | Chrome, Edge, Firefox, Brave, Opera, Vivaldi, Yandex, Whale, Cốc Cốc, 360 Safe, QQ, Sogou, Ecosia, Pale Moon |
          | ❌ **Not Supported** | Safari (requires different format), Internet Explorer (deprecated), Edge Legacy (deprecated) |
          | ⚠️ **Not Applicable** | Mobile browsers (Samsung Internet, UC Browser, etc.) - Xbox Cloud Gaming on mobile uses touch controls |

          ---

          ### Verify Your Download (SHA256)

          Each download has a matching `.sha256` file. To verify:

          **Windows (PowerShell):**
          ```powershell
          Get-FileHash .\Xbox-Cloud-Gaming-KBM-Chrome-v*.zip -Algorithm SHA256
          ```

          **macOS/Linux:**
          ```bash
          sha256sum Xbox-Cloud-Gaming-KBM-Chrome-v*.zip
          ```

          Compare the output with the contents of the `.sha256` file.

          ---

          ### All Checksums

          ```
          NOTES

          cat dist/SHA256SUMS.txt >> release_notes.md

          cat >> release_notes.md << 'NOTES'
          ```
          NOTES

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: v${{ steps.version.outputs.version }}
          body_path: release_notes.md
          files: |
            dist/*.zip
            dist/*.sha256
            dist/SHA256SUMS.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
