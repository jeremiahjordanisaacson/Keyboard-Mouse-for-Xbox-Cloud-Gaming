name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag or input
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Update manifest versions
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          jq --arg v "$VERSION" '.version = $v' manifest.json > tmp.json && mv tmp.json manifest.json
          jq --arg v "$VERSION" '.version = $v' firefox/manifest.json > tmp.json && mv tmp.json firefox/manifest.json

      - name: Package browser extensions
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          mkdir -p dist

          # Files to include in Chromium-based builds
          CHROMIUM_FILES="manifest.json content.js injected.js popup.html popup.js icons/"

          # Create Chromium-based browser packages (same extension, different names for clarity)
          for BROWSER in Chrome Edge Brave Opera Vivaldi; do
            LOWER_BROWSER=$(echo "$BROWSER" | tr '[:upper:]' '[:lower:]')
            zip -r "dist/Xbox-Cloud-Gaming-KBM-${BROWSER}-v${VERSION}.zip" $CHROMIUM_FILES -x "*.git*"
          done

          # Create Firefox package (uses different manifest)
          mkdir -p firefox-build
          cp content.js injected.js popup.html popup.js firefox-build/
          cp -r icons firefox-build/
          cp firefox/manifest.json firefox-build/manifest.json
          cd firefox-build
          zip -r "../dist/Xbox-Cloud-Gaming-KBM-Firefox-v${VERSION}.zip" .

      - name: Generate SHA256 checksums
        run: |
          cd dist
          for file in *.zip; do
            sha256sum "$file" > "${file}.sha256"
          done
          sha256sum *.zip > SHA256SUMS.txt
          echo "=== All Checksums ==="
          cat SHA256SUMS.txt

      - name: Generate release notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cat > release_notes.md << 'NOTES'
          ## Keyboard & Mouse for Xbox Cloud Gaming

          Play Xbox Cloud Gaming with full keyboard and mouse support.

          ---

          ### Download for Your Browser

          | Browser | Download | Checksum |
          |---------|----------|----------|
          NOTES

          # Add each browser to the table
          for BROWSER in Chrome Edge Brave Opera Vivaldi Firefox; do
            ZIP="Xbox-Cloud-Gaming-KBM-${BROWSER}-v${VERSION}.zip"
            echo "| **${BROWSER}** | [${ZIP}](https://github.com/${{ github.repository }}/releases/download/v${VERSION}/${ZIP}) | [SHA256](https://github.com/${{ github.repository }}/releases/download/v${VERSION}/${ZIP}.sha256) |" >> release_notes.md
          done

          cat >> release_notes.md << 'NOTES'

          ---

          ### Installation Instructions

          #### Google Chrome
          1. Download `Xbox-Cloud-Gaming-KBM-Chrome-v*.zip`
          2. Extract the zip file to a folder
          3. Open Chrome and go to `chrome://extensions`
          4. Enable **Developer mode** (toggle in top right)
          5. Click **Load unpacked** and select the extracted folder

          #### Microsoft Edge
          1. Download `Xbox-Cloud-Gaming-KBM-Edge-v*.zip`
          2. Extract the zip file to a folder
          3. Open Edge and go to `edge://extensions`
          4. Enable **Developer mode** (toggle in left sidebar)
          5. Click **Load unpacked** and select the extracted folder

          #### Brave
          1. Download `Xbox-Cloud-Gaming-KBM-Brave-v*.zip`
          2. Extract the zip file to a folder
          3. Open Brave and go to `brave://extensions`
          4. Enable **Developer mode** (toggle in top right)
          5. Click **Load unpacked** and select the extracted folder

          #### Opera
          1. Download `Xbox-Cloud-Gaming-KBM-Opera-v*.zip`
          2. Extract the zip file to a folder
          3. Open Opera and go to `opera://extensions`
          4. Enable **Developer mode** (toggle in top right)
          5. Click **Load unpacked** and select the extracted folder

          #### Vivaldi
          1. Download `Xbox-Cloud-Gaming-KBM-Vivaldi-v*.zip`
          2. Extract the zip file to a folder
          3. Open Vivaldi and go to `vivaldi://extensions`
          4. Enable **Developer mode** (toggle in top right)
          5. Click **Load unpacked** and select the extracted folder

          #### Mozilla Firefox
          1. Download `Xbox-Cloud-Gaming-KBM-Firefox-v*.zip`
          2. Open Firefox and go to `about:debugging#/runtime/this-firefox`
          3. Click **Load Temporary Add-on**
          4. Select the downloaded zip file (no need to extract)

          ---

          ### Verify Your Download (SHA256)

          Each download has a matching `.sha256` file. To verify:

          **Windows (PowerShell):**
          ```powershell
          Get-FileHash .\Xbox-Cloud-Gaming-KBM-Chrome-v*.zip -Algorithm SHA256
          ```

          **macOS/Linux:**
          ```bash
          sha256sum Xbox-Cloud-Gaming-KBM-Chrome-v*.zip
          ```

          Compare the output with the contents of the `.sha256` file.

          ---

          ### All Checksums

          ```
          NOTES

          cat dist/SHA256SUMS.txt >> release_notes.md

          cat >> release_notes.md << 'NOTES'
          ```
          NOTES

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: v${{ steps.version.outputs.version }}
          body_path: release_notes.md
          files: |
            dist/*.zip
            dist/*.sha256
            dist/SHA256SUMS.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
